<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quick Compose Companion</title>
<style>
  :root{
    --c1:#4A7A92;
    --c2:#5A94B1;
    --c3:#C2D6E1;
    --c4:#879B8D;
    --c5:#A0B4A7;
    --c6:#D3DDD7;
    --c7:#756A85;
    --c8:#8E869F;
    --c9:#C4BFD0;
    --ink:#0c1b1f;
    --bg:#ffffff;
    --muted:#5b6b72;
    --radius:16px;
    --shadow:0 10px 25px rgba(20,34,42,0.12);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:linear-gradient(180deg,var(--c3),#eef3f6 40%);color:var(--ink)}
  .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
  header{background:linear-gradient(135deg,var(--c1),var(--c2));color:#fff;border-radius:var(--radius);padding:22px 22px 18px;box-shadow:var(--shadow)}
  header h1{margin:0;font-weight:750;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:18px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 8px;font-size:16px;color:var(--c1)}
  textarea{width:100%;min-height:180px;border:1px solid var(--c3);border-radius:12px;padding:12px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--c1);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(74,122,146,.25)}
  .btn.secondary{background:var(--c7)}
  .btn.ghost{background:#fff;color:var(--c1);border:1px solid var(--c3);box-shadow:none}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:var(--c6);font-size:13px}
  input[type="text"], input[type="email"], select{width:100%;border:1px solid var(--c3);border-radius:10px;padding:10px}
  .mini{font-size:12px;color:var(--muted)}
  .list{border:1px solid var(--c3);border-radius:12px;overflow:hidden}
  .list .rowx{display:grid;grid-template-columns:32px 1.2fr 1.2fr 1fr;gap:10px;padding:10px 12px;border-top:1px solid var(--c6);align-items:center}
  .list .rowx:first-child{border-top:0;background:var(--c6)}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;background:var(--c9);color:#2a2433}
  .tools{display:flex;flex-wrap:wrap;gap:8px}
  .flex{display:flex;gap:10px;align-items:center}
  .k{color:#2a2a2a;font-weight:600}
  .muted{color:var(--muted)}
  .section{margin-top:16px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ccbox{display:flex;flex-wrap:wrap;gap:8px}
  .ccbox .chip{border:1px solid var(--c3);border-radius:999px;padding:8px 10px;background:#fff;cursor:pointer}
  .ccbox .chip.active{background:var(--c3)}
  .foot{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
  .note{background:#fff7e5;border:1px solid #ffe7b2;border-radius:12px;padding:10px}
  .hl{font-weight:700;color:var(--c1)}
  .sm{font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Quick Compose Companion</h1>
    </header>

    <div class="grid">
      <section class="card">
        <h3>1) Paste schedule</h3>
        <textarea id="schedule" placeholder="Paste schedule here (e.g., ‘Wilson, Amanda’, ‘Troyer, Cameron’, etc.)"></textarea>
        <div class="foot">
          <button class="btn" id="extractBtn">Extract teachers</button>
          <button class="btn ghost" id="clearBtn">Clear</button>
          <button class="btn ghost" id="selectAllBtn">Select All</button>
          <button class="btn ghost" id="selectNoneBtn">Select None</button>
        </div>

        <div class="section">
          <h3>2) Detected teachers</h3>
          <div class="mini">Review parsed names and generated emails. Edit if needed or add an exception override.</div>

          <div class="list" id="teacherList">
            <div class="rowx" style="font-weight:700;color:#2a2a2a">
              <div>#</div>
              <div>Name</div>
              <div>Email</div>
              <div>Tools</div>
            </div>
          </div>

          <div class="tools" style="margin-top:10px">
            <button class="btn" id="copyCsv">Copy emails (comma)</button>
            <button class="btn secondary" id="copySemi">Copy emails (semicolon)</button>
          </div>
        </div>
      </section>

      <aside class="card">
        <h3>Options & Templates</h3>

        <div class="section">
          <div class="split">
            <div>
              <label class="mini">Student First Name</label>
              <input type="text" id="studentFirst" placeholder="e.g., Jordan" />
            </div>
            <div>
              <label class="mini">Student Last Name</label>
              <input type="text" id="studentLast" placeholder="e.g., Sharp" />
            </div>
          </div>
        </div>

        <div class="section">
          <label class="mini">Email Template</label>
          <select id="templatePick">
            <option value="blank">Blank (no subject/body)</option>
            <option value="iep">Updated IEP Only</option>
            <option value="bip">Updated IEP + BIP</option>
          </select>
        </div>

        <div class="section">
          <label class="mini">Subject (auto-fills for templates; you can edit)</label>
          <input type="text" id="subjectInput" placeholder="Subject" />
        </div>

        <div class="section">
          <label class="mini">Body</label>
          <textarea id="bodyInput" style="min-height:140px" placeholder="Email body…"></textarea>
        </div>

        <div class="section">
          <label class="mini">CC (toggle common contacts)</label>
          <div class="ccbox" id="ccChips"></div>
          <div class="mini" style="margin-top:6px">Add custom CC (comma-separated)</div>
          <input type="text" id="ccCustom" placeholder="name@wawasee.k12.in.us, another@wawasee.k12.in.us" />
        </div>

        <div class="foot">
          <button class="btn" id="composeGmail">Open in Gmail</button>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:18px">
      <h3>Preloaded CC choices</h3>
      <div class="mini">Click to toggle. Edit this list by clicking the pencil icon below.</div>
      <div class="row" id="ccManageRow" style="margin-top:8px"></div>
      <div class="foot">
        <button class="btn ghost" id="editCcList">Edit CC list</button>
        <button class="btn ghost" id="resetAll">Reset to defaults</button>
      </div>
    </section>
  </div>
<script>
(function(){
  const DOMAIN = "@wawasee.k12.in.us";
  const $ = sel => document.querySelector(sel);

  // ---------- Exceptions (in-memory, no persistence) ----------
  const defaultExceptions = {
    "jill hackleman": "jill.hackleman@wawasee.k12.in.us",
    "janay hackleman": "jhackleman@wawasee.k12.in.us",
    "jennifer phillips": "jennifer.phillips@wawasee.k12.in.us"
  };
  let exceptions = { ...defaultExceptions };

  // ---------- Helpers ----------
  const canonical = (name)=> name.trim().toLowerCase().replace(/\s+/g,' ');
  const stripDiacritics = (s)=> s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
  const cleanForEmail = (s)=> stripDiacritics(s).toLowerCase().replace(/['`\s-]/g,'');

  function ruleEmail(first, last){
    if(!first || !last) return '';
    const fi = cleanForEmail(first)[0] || '';
    const ln = cleanForEmail(last);
    return fi + ln + DOMAIN;
  }

  function nameFromMatch(lastPart, firstPart){
    const last = lastPart.replace(/\s+/g,' ').trim();
    let first = firstPart.trim();
    // strip room code glued to end (e.g., MindyB207)
    first = first.replace(/[A-Z]+\d.*$/, '');
    return { first, last, full: `${first} ${last}` };
  }

  function applyExceptionOrRule({first,last}){
    const key = canonical(`${first} ${last}`);
    if(exceptions[key]) return exceptions[key];
    return ruleEmail(first,last);
  }

  // ---------- Parse schedule ----------
  function parseSchedule(text){
    const results = [];
    const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    const regex = /([A-Z][A-Za-z'\-]*(?:\s[A-Z][A-Za-z'\-]*)*),\s*([A-Z][A-Za-z'\-]+)/g;

    for(const line of lines){
      let m;
      while((m = regex.exec(line))){
        const lastPart  = m[1];
        const firstPart = m[2];
        const {first,last,full} = nameFromMatch(lastPart, firstPart);
        const email = applyExceptionOrRule({first,last});
        results.push({ name: full, first, last, email, selected: true });
      }
    }
    // de-dupe by email
    const seen = new Set();
    return results.filter(x=>{
      const k = (x.email || '').toLowerCase();
      if(!k || seen.has(k)) return false;
      seen.add(k); return true;
    });
  }

  // ---------- State ----------
  let detected = [];

  // ---------- Render detected list ----------
  function renderDetected(){
    const box = $('#teacherList');
    box.querySelectorAll('.rowx.data').forEach(n=>n.remove());
    detected.forEach((t,i)=>{
      const row = document.createElement('div');
      row.className = 'rowx data';
      row.innerHTML = `
        <div><input type="checkbox" data-idx="${i}" class="sel" ${t.selected? 'checked':''}></div>
        <div>
          <div class="k">${t.name}</div>
          <div class="mini">First: ${t.first} &nbsp; Last: ${t.last}</div>
        </div>
        <div>
          <input type="text" value="${t.email}" data-idx="${i}" class="emailEdit" />
        </div>
        <div class="flex">
          <button class="btn ghost" data-idx="${i}" data-act="makeException">Save as exception</button>
          <button class="btn ghost" data-idx="${i}" data-act="recompute">Recompute</button>
        </div>`;
      box.appendChild(row);
    });
  }

  // ---------- CC chips ----------
  const defaultCcList = [
    { name: "Jesse Ritter", email: "jritter@wawasee.k12.in.us" },
    { name: "Christy Troutman", email: "ctroutman@wawasee.k12.in.us" },
    { name: "Wendy Ortiz", email: "wortiz@wawasee.k12.in.us" },
    { name: "David Shipley", email: "dshipley@wawasee.k12.in.us" },
    { name: "Jill Hackleman", email: "jill.hackleman@wawasee.k12.in.us" },
    { name: "Kari Baker", email: "kbaker@wawasee.k12.in.us" }
  ];
  let ccList = JSON.parse(JSON.stringify(defaultCcList));
  let ccActive = new Set();

  function renderCcChips(){
    const chips = $('#ccChips');
    chips.innerHTML = '';
    ccList.forEach((p)=>{
      const div = document.createElement('div');
      div.className = 'chip' + (ccActive.has(p.email)?' active':'');
      div.textContent = p.name;
      div.title = p.email;
      div.onclick = ()=>{
        if(ccActive.has(p.email)) ccActive.delete(p.email);
        else ccActive.add(p.email);
        renderCcChips();
      };
      chips.appendChild(div);
    });
  }

  function renderCcManageRow(){
    const row = $('#ccManageRow');
    row.innerHTML = '';
    ccList.forEach(p=>{
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.innerHTML = `<span>${p.name}</span><span class="mini">${p.email}</span>`;
      row.appendChild(pill);
    });
  }

  // ---------- Templates ----------
  function firstInitial(){
    const f = ($('#studentFirst').value||'').trim();
    return f? f[0].toUpperCase()+'.' : '';
  }
  function lastName(){ return ($('#studentLast').value||'').trim(); }

  function fillTemplate(kind){
    const F = firstInitial();
    const L = lastName();
    const First = ($('#studentFirst').value||'').trim();
    const Full = [First, L].filter(Boolean).join(' ');
    let subject = '';
    let body = '';

    if(kind === 'iep'){
      subject = `${F} ${L} – Updated IEP`.trim();
      body = [
        'Hello Team,',
        '',
        `Attached you will find the updated IEP for ${Full || '[Student’s Full Name]'}. Please take a few minutes to review the document and let me know if you have any questions, concerns, or need clarification on any of the supports, accommodations, or services listed.`,
        '',
        `Thank you for your attention to this update and for your continued support of ${First || '[Student’s First Name]'}.`,
        '',
        'Best,',
        'Jesse Ritter',
        'Special Education Teacher'
      ].join('\\n');
    } else if(kind === 'bip'){
      subject = `${F} ${L} – Updated IEP and BIP`.trim();
      body = [
        'Hello Team,',
        '',
        `Attached you will find the updated IEP and Behavior Intervention Plan (BIP) for ${Full || '[Student’s Full Name]'}. Please review both documents carefully and reach out with any questions or concerns about implementation, accommodations, or expectations.`,
        '',
        `Thank you for your attention to this update and for your continued support of ${First || '[Student’s First Name]'}.`,
        '',
        'Best,',
        'Jesse Ritter',
        'Special Education Teacher'
      ].join('\\n');
    } else {
      subject = '';
      body = '';
    }

    $('#subjectInput').value = subject;
    $('#bodyInput').value = body;
  }

  // ---------- Compose in Gmail ----------
  function composeUrl(){
    const to = detected.filter(x=>x.selected && x.email).map(x=>x.email);
    const ccPreset = Array.from(ccActive);
    const ccCustom = ($('#ccCustom').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const cc = [...ccPreset, ...ccCustom];

    const su   = encodeURIComponent($('#subjectInput').value||'');
    const body = encodeURIComponent($('#bodyInput').value||'');
    const toParam = encodeURIComponent(to.join(','));
    const ccParam = encodeURIComponent(cc.join(','));

    let url = `https://mail.google.com/mail/?view=cm&fs=1&to=${toParam}`;
    if(cc.length) url += `&cc=${ccParam}`;
    if(su) url += `&su=${su}`;
    if(body) url += `&body=${body}`;
    return url;
  }

  // ---------- Wire events ----------
  // Extract/Clear & selection
  $('#extractBtn').onclick    = ()=>{ detected = parseSchedule($('#schedule').value||''); renderDetected(); };
  $('#clearBtn').onclick      = ()=>{ $('#schedule').value=''; detected=[]; renderDetected(); };
  $('#selectAllBtn').onclick  = ()=>{ detected.forEach(d=>d.selected=true);  renderDetected(); };
  $('#selectNoneBtn').onclick = ()=>{ detected.forEach(d=>d.selected=false); renderDetected(); };

  // Detected list (edit/select/exception/recompute)
  $('#teacherList').addEventListener('input', (e)=>{
    const t = e.target;
    if(t.classList.contains('emailEdit')){
      const idx = Number(t.dataset.idx);
      detected[idx].email = t.value.trim();
    }
  });
  $('#teacherList').addEventListener('change', (e)=>{
    const t = e.target;
    if(t.classList.contains('sel')){
      const idx = Number(t.dataset.idx);
      detected[idx].selected = t.checked;
    }
  });
  $('#teacherList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const idx = Number(btn.dataset.idx);
    const act = btn.dataset.act;
    if(act === 'makeException'){
      const key = canonical(detected[idx].name);
      exceptions[key] = detected[idx].email.trim();
      alert('Saved exception for ' + detected[idx].name);
    }
    if(act === 'recompute'){
      const {first,last} = detected[idx];
      detected[idx].email = applyExceptionOrRule({first,last});
      renderDetected();
    }
  });

  // Copy emails
  $('#copyCsv').onclick = ()=>{
    const list = detected.filter(x=>x.selected && x.email).map(x=>x.email).join(', ');
    navigator.clipboard.writeText(list);
  };
  $('#copySemi').onclick = ()=>{
    const list = detected.filter(x=>x.selected && x.email).map(x=>x.email).join('; ');
    navigator.clipboard.writeText(list);
  };

  // Templates + student fields
  $('#templatePick').onchange = (e)=> fillTemplate(e.target.value);
  $('#studentFirst').addEventListener('input', ()=> fillTemplate($('#templatePick').value));
  $('#studentLast').addEventListener('input',  ()=> fillTemplate($('#templatePick').value));

  // CC controls
  function initCc(){ renderCcChips(); renderCcManageRow(); }
  $('#editCcList').onclick = ()=>{
    const data = prompt('Edit CC list as JSON (array of {name, email})', JSON.stringify(ccList, null, 2));
    if(!data) return;
    try{
      const arr = JSON.parse(data);
      if(!Array.isArray(arr)) throw new Error('Not an array');
      ccList = arr; ccActive = new Set(); initCc();
    }catch(err){ alert('Invalid JSON.'); }
  };
  $('#resetAll').onclick = ()=>{ ccList = JSON.parse(JSON.stringify(defaultCcList)); ccActive = new Set(); initCc(); };

  // Compose
  $('#composeGmail').onclick = ()=>{ window.open(composeUrl(), '_blank'); };

  // ---------- Init ----------
  initCc();
  renderDetected();
  fillTemplate('blank');
})();
</script>
</body>
</html>
